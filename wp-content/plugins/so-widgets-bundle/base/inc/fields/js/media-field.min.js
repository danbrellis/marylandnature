!function(f){f(document).on("sowsetupformfield",".siteorigin-widget-field-type-media",function(e){var n=f(this),t=n.find("> .media-field-wrapper"),r=n.find(".siteorigin-widget-input").not(".media-fallback-external");if(!t.data("initialized")){var u;t.find(".media-upload-button").click(function(e){if(e.preventDefault(),void 0!==wp.media){var t=f(this),i=f(this).data("frame");if(i)return i.open(),!1;i=wp.media({title:t.data("choose"),library:{type:t.data("library").split(",").map(function(e){return e.trim()})},button:{text:t.data("update"),close:!1}}),t.data("frame",i),i.on("select",function(){var e=i.state().get("selection").first().attributes;n.find(".current .title").html(e.title),r.val(e.id),r.trigger("change",{silent:!0});var t=n.find(".current .thumbnail");void 0!==e.sizes?void 0!==e.sizes.thumbnail?t.attr("src",e.sizes.thumbnail.url).fadeIn():t.attr("src",e.sizes.full.url).fadeIn():t.attr("src",e.icon).fadeIn(),n.find(".media-remove-button").removeClass("remove-hide"),i.close()}),i.open()}}),t.find(".current").mouseenter(function(){var e=f(this).find(".title");""!==e.html()&&e.fadeIn("fast")}).mouseleave(function(){f(this).find(".title").clearQueue().fadeOut("fast")}),n.find("a.media-remove-button").click(function(e){e.preventDefault(),n.find(".current .title").html(""),r.val(""),r.trigger("change",{silent:!0}),n.find(".current .thumbnail").fadeOut("fast"),f(this).addClass("remove-hide")});var s=function(){if(u){var e=u.find(".so-widgets-image-results");if(0!==e.length){var t=e.width(),i=Math.floor(t/276),a=(t-276*i)/i+260;e.find(".so-widgets-result-image").css({width:a,height:a/1.4})}}};f(window).resize(s);t.find(".find-image-button").click(function(e){e.preventDefault(),function(){if(!u){(u=f(f("#so-widgets-bundle-tpl-image-search-dialog").html().trim()).appendTo("body")).find(".close").click(function(){u.hide()});var e,a=u.find(".so-widgets-image-results"),i=function(t,i){u.find(".so-widgets-results-loading").fadeIn("fast"),u.find(".so-widgets-results-loading strong").html(u.find(".so-widgets-results-loading strong").data("loading")),u.find(".so-widgets-results-more").hide(),f.get(ajaxurl,{action:"so_widgets_image_search",q:t,page:i,_sononce:u.find('input[name="_sononce"]').val()},function(e){e.error?alert(e.message):(a.removeClass("so-loading"),f.each(e.items,function(e,t){var i=f(f("#so-widgets-bundle-tpl-image-search-result").html().trim()).appendTo(a).addClass("source-"+t.source).find(".so-widgets-result-image");i.css("background-image","url("+t.thumbnail+")"),i.data("thumbnail",t.thumbnail),i.data("preview",t.preview),t.url&&i.attr({href:t.url,target:"_blank"}),t.full_url&&(i.data({full_url:t.full_url,import_signature:t.import_signature}),i.attr("href",t.full_url)),"shutterstock"===t.source&&i.append(f("#so-widgets-bundle-tpl-image-search-result-sponsored").html())}),1===i&&(u.find("#so-widgets-image-search-suggestions ul").empty(),f.each(e.keywords,function(e,t){u.find("#so-widgets-image-search-suggestions").show(),u.find("#so-widgets-image-search-suggestions ul").append(f("<li></li>").append(f('<a href="#"></a>').html(t).data("keyword",t)))})),u.find(".so-widgets-results-loading").fadeOut("fast"),s(),u.find(".so-widgets-results-more").show().find("button").data({query:t,page:i+1}))})};u.find("#so-widgets-image-search-form").submit(function(e){e.preventDefault();var t=u.find(".so-widgets-search-input").val();a.empty(),""!==t&&i(t,1)}),u.on("click",".so-keywords-list a",function(e){e.preventDefault();var t=f(this).blur();u.find(".so-widgets-search-input").val(t.data("keyword")),u.find("#so-widgets-image-search-form").submit()}),u.find(".so-widgets-results-more button").click(function(){var e=f(this);i(e.data("query"),e.data("page"))}),u.on("click",".so-widgets-result-image",function(e){var t=f(this);if(t.data("full_url")&&(e.preventDefault(),confirm(u.data("confirm-import")))){u.addClass("so-widgets-importing");var i=f("#post_ID").val();null===i&&(i=""),f.get(ajaxurl,{action:"so_widgets_image_import",full_url:t.data("full_url"),import_signature:t.data("import_signature"),post_id:i,_sononce:u.find('input[name="_sononce"]').val()},function(e){u.find("#so-widgets-image-search-frame").removeClass("so-widgets-importing"),!1===e.error?(u.hide(),u.find(".so-widgets-results-loading").hide(),r.val(e.attachment_id).trigger("change",{silent:!0}),n.find(".current .thumbnail").attr("src",e.thumb).fadeIn(),n.find(".media-remove-button").removeClass("remove-hide")):(alert(e.message),u.find(".so-widgets-results-loading").hide())}),u.find(".so-widgets-results-loading").fadeIn("fast"),u.find(".so-widgets-results-loading strong").html(u.find(".so-widgets-results-loading strong").data("importing")),u.find(".so-widgets-results-more").hide(),u.find("#so-widgets-image-search-frame").addClass("so-widgets-importing")}});var o,d,l=u.find(".so-widgets-preview-window");u.on("mouseenter",".so-widgets-result-image",function(){var a=f(this),s=a.data("preview");clearTimeout(e),e=setTimeout(function(){var e=1,t=1;s[1]>.33*f(window).outerWidth()&&(e=.33*f(window).outerWidth()/s[1]),s[2]>.5*f(window).outerHeight()&&(t=.5*f(window).outerHeight()/s[2]);var i=Math.min(e,t);1<i&&(i=1),l.show().find(".so-widgets-preview-window-inside").css({"background-image":"url("+a.data("thumbnail")+")",width:s[1]*i,height:s[2]*i}).append(f("<img />").attr("src",s[0])),u.trigger("mousemove")},1e3)}).on("mouseleave",".so-widgets-result-image",function(){l.hide().find("img").remove(),clearTimeout(e)}),u.on("mousemove",function(e){if(e.clientX&&(o=e.clientX),e.clientY&&(d=e.clientY),l.is(":visible")){var t=l.outerHeight(),i=l.outerWidth(),a=f(window).outerHeight(),s=f(window).outerWidth(),n=d-t/2;n=Math.max(n,10),n=Math.min(n,a-10-t);var r=o<s/2?o+15:o-15-i;l.css({top:n,left:r})}})}u.show(),u.find(".so-widgets-search-input").focus()}()}),r.change(function(e,t){if(!t||!t.silent){var i=r.val();if(i){var a=n.find(".current .thumbnail"),s=wp.media.attachment(i);s.fetch().done(function(){if(s.has("sizes")){var e=s.get("sizes");void 0!==e.thumbnail?a.attr("src",e.thumbnail.url).fadeIn():a.attr("src",e.full.url).fadeIn()}else a.attr("src",s.get("icon")).fadeIn();n.find(".media-remove-button").removeClass("remove-hide")})}else n.find("a.media-remove-button").click()}}),t.data("initialized",!0)}})}(jQuery);