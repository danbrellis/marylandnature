!function(e){e(document).on("sowsetupformfield",".siteorigin-widget-field-type-media",function(t){var i=e(this),s=i.find("> .media-field-wrapper"),n=i.find(".siteorigin-widget-input").not(".media-fallback-external");s.find(".media-upload-button").click(function(t){if(t.preventDefault(),"undefined"!=typeof wp.media){var s=e(this),a=e(this).data("frame");if(a)return a.open(),!1;a=wp.media({title:s.data("choose"),library:{type:s.data("library").split(",").map(function(e){return e.trim()})},button:{text:s.data("update"),close:!1}}),s.data("frame",a),a.on("select",function(){var e=a.state().get("selection").first().attributes;i.find(".current .title").html(e.title),n.val(e.id),n.trigger("change",{silent:!0});var t=i.find(".current .thumbnail");"undefined"!=typeof e.sizes?"undefined"!=typeof e.sizes.thumbnail?t.attr("src",e.sizes.thumbnail.url).fadeIn():t.attr("src",e.sizes.full.url).fadeIn():t.attr("src",e.icon).fadeIn(),i.find(".media-remove-button").removeClass("remove-hide"),a.close()}),a.open()}}),s.find(".current").mouseenter(function(){var t=e(this).find(".title");""!==t.html()&&t.fadeIn("fast")}).mouseleave(function(){e(this).find(".title").clearQueue().fadeOut("fast")}),i.find("a.media-remove-button").click(function(t){t.preventDefault(),i.find(".current .title").html(""),n.val(""),i.find(".current .thumbnail").fadeOut("fast"),e(this).addClass("remove-hide")});var a=!1,r=function(){if(a){var e=a.find(".so-widgets-image-results");if(0!==e.length){var t=e.width(),i=Math.floor(t/276),s=t-276*i,n=s/i+260;e.find(".so-widgets-result-image").css({width:n,height:n/1.4})}}};e(window).resize(r);var o=function(){if(!a){a=e(e("#so-widgets-bundle-tpl-image-search-dialog").html().trim()).appendTo("body"),a.find(".close").click(function(){a.hide()});var t=a.find(".so-widgets-image-results"),s=function(i,s){a.find(".so-widgets-results-loading").fadeIn("fast"),a.find(".so-widgets-results-loading strong").html(a.find(".so-widgets-results-loading strong").data("loading")),a.find(".so-widgets-results-more").hide(),e.get(ajaxurl,{action:"so_widgets_image_search",q:i,page:s,_sononce:a.find('input[name="_sononce"]').val()},function(n){return n.error?void alert(n.message):(t.removeClass("so-loading"),e.each(n.items,function(i,s){var n=e(e("#so-widgets-bundle-tpl-image-search-result").html().trim()).appendTo(t).addClass("source-"+s.source),a=n.find(".so-widgets-result-image");a.css("background-image","url("+s.thumbnail+")"),a.data("thumbnail",s.thumbnail),a.data("preview",s.preview),s.url&&a.attr({href:s.url,target:"_blank"}),s.full_url&&(a.data({full_url:s.full_url,import_signature:s.import_signature}),a.attr("href",s.full_url)),"shutterstock"===s.source&&a.append(e("#so-widgets-bundle-tpl-image-search-result-sponsored").html())}),1===s&&(a.find("#so-widgets-image-search-suggestions ul").empty(),e.each(n.keywords,function(t,i){a.find("#so-widgets-image-search-suggestions").show(),a.find("#so-widgets-image-search-suggestions ul").append(e("<li></li>").append(e('<a href="#"></a>').html(i).data("keyword",i)))})),a.find(".so-widgets-results-loading").fadeOut("fast"),r(),void a.find(".so-widgets-results-more").show().find("button").data({query:i,page:s+1}))})};a.find("#so-widgets-image-search-form").submit(function(e){e.preventDefault();var i=a.find(".so-widgets-search-input").val();t.empty(),""!==i&&s(i,1)}),a.on("click",".so-keywords-list a",function(t){t.preventDefault();var i=e(this).blur();a.find(".so-widgets-search-input").val(i.data("keyword")),a.find("#so-widgets-image-search-form").submit()}),a.find(".so-widgets-results-more button").click(function(){var t=e(this);s(t.data("query"),t.data("page"))});var o;a.on("click",".so-widgets-result-image",function(t){var s=e(this);if(s.data("full_url")&&(t.preventDefault(),confirm(a.data("confirm-import")))){a.addClass("so-widgets-importing");var r=e("#post_ID").val();null===r&&(r=""),e.get(ajaxurl,{action:"so_widgets_image_import",full_url:s.data("full_url"),import_signature:s.data("import_signature"),post_id:r,_sononce:a.find('input[name="_sononce"]').val()},function(e){a.find("#so-widgets-image-search-frame").removeClass("so-widgets-importing"),e.error===!1?(a.hide(),a.find(".so-widgets-results-loading").hide(),n.val(e.attachment_id).trigger("change",{silent:!0}),i.find(".current .thumbnail").attr("src",e.thumb).fadeIn(),i.find(".media-remove-button").removeClass("remove-hide")):(alert(e.message),a.find(".so-widgets-results-loading").hide())}),a.find(".so-widgets-results-loading").fadeIn("fast"),a.find(".so-widgets-results-loading strong").html(a.find(".so-widgets-results-loading strong").data("importing")),a.find(".so-widgets-results-more").hide(),a.find("#so-widgets-image-search-frame").addClass("so-widgets-importing")}});var d=a.find(".so-widgets-preview-window");a.on("mouseenter",".so-widgets-result-image",function(){var t=e(this),i=t.data("preview");clearTimeout(o),o=setTimeout(function(){var s=1,n=1;i[1]>.33*e(window).outerWidth()&&(s=.33*e(window).outerWidth()/i[1]),i[2]>.5*e(window).outerHeight()&&(n=.5*e(window).outerHeight()/i[2]);var r=Math.min(s,n);r>1&&(r=1),d.show().find(".so-widgets-preview-window-inside").css({"background-image":"url("+t.data("thumbnail")+")",width:i[1]*r,height:i[2]*r}).append(e("<img />").attr("src",i[0])),a.trigger("mousemove")},1e3)}).on("mouseleave",".so-widgets-result-image",function(){d.hide().find("img").remove(),clearTimeout(o)});var l,u;a.on("mousemove",function(t){if(t.clientX&&(l=t.clientX),t.clientY&&(u=t.clientY),d.is(":visible")){var i=d.outerHeight(),s=d.outerWidth(),n=e(window).outerHeight(),a=e(window).outerWidth(),r=u-i/2;r=Math.max(r,10),r=Math.min(r,n-10-i);var o=l<a/2?l+15:l-15-s;d.css({top:r,left:o})}})}a.show(),a.find(".so-widgets-search-input").focus()};s.find(".find-image-button").click(function(e){e.preventDefault(),o()}),n.change(function(e,t){if(!t||!t.silent){var s=n.val();if(s){var a=i.find(".current .thumbnail"),r=wp.media.attachment(s);r.fetch().done(function(){if(r.has("sizes")){var e=r.get("sizes");"undefined"!=typeof e.thumbnail?a.attr("src",e.thumbnail.url).fadeIn():a.attr("src",e.full.url).fadeIn()}else a.attr("src",r.get("icon")).fadeIn();i.find(".media-remove-button").removeClass("remove-hide")})}else i.find("a.media-remove-button").click()}})})}(jQuery);